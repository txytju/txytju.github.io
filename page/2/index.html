<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  
    
      
    

    
  

  

  
    
      
    

    
  

  
    
      
    

    
  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Monda:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Lobster Two:300,300italic,400,400italic,700,700italic|PT Mono:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/dog.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/dog.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/dog.png?v=5.1.4">


  <link rel="mask-icon" href="/images/dog.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Computer Vision, Deep Learning, Machine Learning" />










<meta property="og:type" content="website">
<meta property="og:title" content="Xingye Tian">
<meta property="og:url" content="http://xytian.me/page/2/index.html">
<meta property="og:site_name" content="Xingye Tian">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Xingye Tian">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"right","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://xytian.me/page/2/"/>





  <title>Xingye Tian</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-right 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Xingye Tian</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Machine Learning for Computer Vision.</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://xytian.me/2018/05/01/Research-Notes/Object Detection and Segmentation/3. Object Detection/3. No Region Proposal/SSD/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Xingye Tian">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://p3rz3gu1u.bkt.clouddn.com/2018-07-26-ME.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Xingye Tian">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/05/01/Research-Notes/Object Detection and Segmentation/3. Object Detection/3. No Region Proposal/SSD/" itemprop="url">Untitled</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-05-01T06:43:30+08:00">
                2018-05-01
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">Post modified&#58;</span>
              
              <time title="Post modified" itemprop="dateModified" datetime="2018-07-09T16:05:19+08:00">
                2018-07-09
              </time>
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://xytian.me/2018/05/01/Research-Notes/Neural-Networks/Batch-Normalization/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Xingye Tian">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://p3rz3gu1u.bkt.clouddn.com/2018-07-26-ME.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Xingye Tian">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/05/01/Research-Notes/Neural-Networks/Batch-Normalization/" itemprop="url">Untitled</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-05-01T06:43:30+08:00">
                2018-05-01
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">Post modified&#58;</span>
              
              <time title="Post modified" itemprop="dateModified" datetime="2018-07-01T15:04:32+08:00">
                2018-07-01
              </time>
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://xytian.me/2018/05/01/Research-Notes/Object Detection and Segmentation/1. Semantic Segmentation/2017-TPAMI-A Review on Deep Learning Techniques Applied to Semantic Segmentation/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Xingye Tian">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://p3rz3gu1u.bkt.clouddn.com/2018-07-26-ME.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Xingye Tian">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/05/01/Research-Notes/Object Detection and Segmentation/1. Semantic Segmentation/2017-TPAMI-A Review on Deep Learning Techniques Applied to Semantic Segmentation/" itemprop="url">2017-TPAMI-A Review on Deep Learning Techniques Applied to Semantic Segmentation</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-05-01T06:43:30+08:00">
                2018-05-01
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">Post modified&#58;</span>
              
              <time title="Post modified" itemprop="dateModified" datetime="2018-07-26T19:21:55+08:00">
                2018-07-26
              </time>
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Object-Detection-and-Segmentation/" itemprop="url" rel="index">
                    <span itemprop="name">Object Detection and Segmentation</span>
                  </a>
                </span>

                
                
                  >
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Object-Detection-and-Segmentation/Semantic-Segmentation/" itemprop="url" rel="index">
                    <span itemprop="name">Semantic Segmentation</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>A basic summary of research approach about semantic segmentation in recent years.</p>
<h2 id="Main-parts-of-this-summary-paper-are"><a href="#Main-parts-of-this-summary-paper-are" class="headerlink" title="Main parts of this summary paper are :"></a>Main parts of this summary paper are :</h2><ul>
<li>Datasets that are used in different segmentation tasks.</li>
<li>Metrics that are used to evaluate the performance of different models.</li>
<li>Methods that show promising results in segmentation tasks.</li>
<li>Some promising future works.</li>
</ul>
<h2 id="Some-key-ideas"><a href="#Some-key-ideas" class="headerlink" title="Some key ideas"></a>Some key ideas</h2><ul>
<li><p>Looking at the big picture, semantic segmentation is one of the high-level task that paves the way towards complete scene understanding. </p>
<ul>
<li><p>Comments : From image classification, object detection, to semantic segmentation and instance segmentation, the complexity of tasks are increasing, however, the information we can get from the 4 tasks are also increasing.</p>
<p><img src="/var/folders/_1/lk5lfxl91894yv34ffy7h2x40000gn/T/abnerworks.Typora/image-20180707172311096.png" alt="image-20180707172311096"></p>
</li>
</ul>
</li>
<li><p>The main content of this paper is inspiring about what to learn when you try to learn about a branch of machine learning especially computer vision. The 3 important aspects are methods(algorithms), datasets and metrics. </p>
<ul>
<li>You  can train the model on some dataset and finally evaluate the performance with some metric. With these 3 parts, you can keep testing the performance and improving your methods until you finally find the best method suitble for your task.</li>
</ul>
</li>
<li><p>Transfor learning features even from distant tasks can be better than using random initialization, so maybe use transfor learning as possible as you can.</p>
<ul>
<li>Labling in semantic segmentation is expensive, so transfor learning is very important in semantic segmentation tasks.</li>
<li>Because most of pre-trained models are pre-trained on some spefic models like VGG or ResNet, so use them if possible, rather than train your own model from scratch unless you are trying to creat your own model and write a paper.</li>
<li>Although fine-tuning is a terminology that is often used together with transfor learning, it’s not part of transfor learning. The relationship between the two is quite clear in cs231n : they are totally different terminology, but fine-tuning is always needed when applying transfor learning. Using small learning rate and choosing which layers to freeze are 2 very important key ideas when applying fine-tuning.</li>
</ul>
</li>
<li><p>PASCAL VOC and COCO dataset are often used in semantic segmentation tasks.</p>
</li>
<li><p>Evaluation Metrics</p>
<ul>
<li><p>Execution time (satisfying metric)</p>
</li>
<li><p>Memory footprint (satisfying metric)</p>
</li>
<li><p>Accuracy (optimal metric)</p>
<ul>
<li>pixel accuracy (PA)</li>
<li>mean pixel accuracy (MPA)</li>
<li>mean intersection over union (MIoU) : most standrad metric in semantic segmentation.</li>
<li>frequency weighted IoU (FWIoU)</li>
</ul>
<p>|                              PA                              |                             MPA                              |                             MIoU                             |                            FWIoU                             |<br>| :———————————————————-: | :———————————————————-: | :———————————————————-: | :———————————————————-: |<br>| </p><p float="left"> <img src="http://p3rz3gu1u.bkt.clouddn.com/2018-07-07-094500.png" width="300">  </p> | <p float="left"> <img src="http://p3rz3gu1u.bkt.clouddn.com/2018-07-07-094512.png" width="300">  </p> | <p float="left"> <img src="http://p3rz3gu1u.bkt.clouddn.com/2018-07-07-094525.png" width="400">  </p> | <p float="left"> <img src="http://p3rz3gu1u.bkt.clouddn.com/2018-07-07-094533.png" width="400">  </p> |<p></p>
</li>
<li><p>Methods of semantic segmentation will be introduced when reading that spefic paper.</p>
</li>
</ul>
</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://xytian.me/2018/05/01/Research-Notes/Object Detection and Segmentation/1. Semantic Segmentation/README/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Xingye Tian">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://p3rz3gu1u.bkt.clouddn.com/2018-07-26-ME.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Xingye Tian">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/05/01/Research-Notes/Object Detection and Segmentation/1. Semantic Segmentation/README/" itemprop="url">Untitled</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-05-01T06:43:30+08:00">
                2018-05-01
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">Post modified&#58;</span>
              
              <time title="Post modified" itemprop="dateModified" datetime="2018-07-13T17:11:42+08:00">
                2018-07-13
              </time>
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a href="2017-TPAMI-A Review on Deep Learning Techniques Applied to Semantic Segmentation.md">2017-TPAMI-A Review on Deep Learning Techniques Applied to Semantic Segmentation.md</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://xytian.me/2018/05/01/Research-Notes/Object Detection and Segmentation/4. Instance Segmentation/2017-ICCV-Mask R-CNN/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Xingye Tian">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://p3rz3gu1u.bkt.clouddn.com/2018-07-26-ME.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Xingye Tian">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/05/01/Research-Notes/Object Detection and Segmentation/4. Instance Segmentation/2017-ICCV-Mask R-CNN/" itemprop="url">Feature Pyramid Networks</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-05-01T06:43:30+08:00">
                2018-05-01
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">Post modified&#58;</span>
              
              <time title="Post modified" itemprop="dateModified" datetime="2018-07-26T19:11:22+08:00">
                2018-07-26
              </time>
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/General-Object-Detection/" itemprop="url" rel="index">
                    <span itemprop="name">General-Object-Detection</span>
                  </a>
                </span>

                
                
                  >
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/General-Object-Detection/No-Region-Proposal/" itemprop="url" rel="index">
                    <span itemprop="name">No-Region-Proposal</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Key-Ideas"><a href="#Key-Ideas" class="headerlink" title="Key Ideas"></a>Key Ideas</h2><ul>
<li>Achieved instance segmentation task based on Faster R-CNN framework.</li>
<li>Another branch besides class and localization branch to generate instance mask, and this branch is totally FCN.</li>
<li>RoI Align is used rather than RoI Pooling, which help keep Equivariance.<ul>
<li>What does “Equivariance” mean? Changes in the input lead to corresponding changes in output.</li>
</ul>
</li>
</ul>
<h2 id="Equivariance-in-Mask-R-CNN"><a href="#Equivariance-in-Mask-R-CNN" class="headerlink" title="Equivariance in Mask R-CNN"></a>Equivariance in Mask R-CNN</h2><p><img src="/var/folders/_1/lk5lfxl91894yv34ffy7h2x40000gn/T/abnerworks.Typora/image-20180709141857506.png" alt="image-20180709141857506"></p>
<p><img src="/var/folders/_1/lk5lfxl91894yv34ffy7h2x40000gn/T/abnerworks.Typora/image-20180709141919831.png" alt="image-20180709141919831"></p>
<p><img src="/var/folders/_1/lk5lfxl91894yv34ffy7h2x40000gn/T/abnerworks.Typora/image-20180709141947021.png" alt="image-20180709141947021"></p>
<p><img src="/var/folders/_1/lk5lfxl91894yv34ffy7h2x40000gn/T/abnerworks.Typora/image-20180709142001092.png" alt="image-20180709142001092"></p>
<p>Check He’s speech on ICCV’17 Tutorial for more detail.</p>
<h2 id="RoI-Align-and-RoI-Pooling"><a href="#RoI-Align-and-RoI-Pooling" class="headerlink" title="RoI Align and RoI Pooling"></a>RoI Align and RoI Pooling</h2><ul>
<li>RoI Align is one of the key factors of the success of Mask R-CNN. RoI Pooling experienced 2 quantizations during the process, but RoI Align do not. You can check <a href="http://blog.leanote.com/post/afanti.deng@gmail.com/b5f4f526490b" target="_blank" rel="noopener">this page</a> for more details.</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:center">RoI Pooling</th>
<th style="text-align:center">RoI Align</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><p float="left"> <img src="http://p3rz3gu1u.bkt.clouddn.com/2018-07-09-065302.png" width="400">  </p></td>
<td style="text-align:center"><p float="left"> <img src="http://p3rz3gu1u.bkt.clouddn.com/2018-07-09-065357.png" width="400">  </p></td>
</tr>
</tbody>
</table>
<h2 id="RoI-Align-Code-in-Caffe"><a href="#RoI-Align-Code-in-Caffe" class="headerlink" title="RoI Align Code in Caffe"></a>RoI Align Code in Caffe</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">#include "roi_align_op.h"</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">#include "caffe2/utils/eigen_utils.h"</span></span><br><span class="line"><span class="comment">#include "caffe2/utils/math.h"</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">#ifdef CAFFE2_USE_MKL</span></span><br><span class="line"><span class="comment">#include "caffe2/mkl/operators/operator_fallback_mkl.h"</span></span><br><span class="line"><span class="comment">#endif // CAFFE2_USE_MKL</span></span><br><span class="line"> </span><br><span class="line">namespace caffe2 &#123;</span><br><span class="line">namespace &#123;</span><br><span class="line"> </span><br><span class="line">template &lt;typename T&gt;</span><br><span class="line">struct PreCalc &#123;</span><br><span class="line">  int pos1;</span><br><span class="line">  int pos2;</span><br><span class="line">  int pos3;</span><br><span class="line">  int pos4;</span><br><span class="line">  T w1;</span><br><span class="line">  T w2;</span><br><span class="line">  T w3;</span><br><span class="line">  T w4;</span><br><span class="line">&#125;;</span><br><span class="line"> </span><br><span class="line">/*</span><br><span class="line">height,//输入数据的第三个维度长度即h</span><br><span class="line">width,//输入数据的第四个维度长度即w</span><br><span class="line">roi_start_h,//roi在输入图像中的坐标y1变换到roialign输入featuremap的坐标，float型</span><br><span class="line">roi_start_w,//roi在输入图像中的坐标x1变换到roialign输入featuremap的坐标，float型    </span><br><span class="line">roi_bin_grid_h,//每个小网格内用于pooling的垂直方向采样点数</span><br><span class="line">roi_bin_grid_w,//每个小网格内用于pooling的水平方向采样点数</span><br><span class="line">    </span><br><span class="line">pooled_height,//pooling后的h</span><br><span class="line">pooled_width,//pooling后的w</span><br><span class="line">iy_upper,//每个小网格内用于pooling的垂直方向采样点数</span><br><span class="line">ix_upper,//每个小网格内用于pooling的水平方向采样点数</span><br><span class="line">bin_size_h,//每个roi分块后每个小块垂直方向包含的bin数量（即尺寸）</span><br><span class="line">bin_size_w,//每个roi分块后每个小块水平方向包含的bin数量（即尺寸）</span><br><span class="line">*/</span><br><span class="line">//获得双线性插值采样点周围四个坐标的索引以及对应的权重</span><br><span class="line">template &lt;typename T&gt;</span><br><span class="line">void pre_calc_for_bilinear_interpolate(</span><br><span class="line">    const int height,</span><br><span class="line">    const int width,</span><br><span class="line">    const int pooled_height,</span><br><span class="line">    const int pooled_width,</span><br><span class="line">    const int iy_upper,</span><br><span class="line">    const int ix_upper,</span><br><span class="line">    T roi_start_h,</span><br><span class="line">    T roi_start_w,</span><br><span class="line">    T bin_size_h,</span><br><span class="line">    T bin_size_w,</span><br><span class="line">    int roi_bin_grid_h,</span><br><span class="line">    int roi_bin_grid_w,</span><br><span class="line">    std::vector&lt;PreCalc&lt;T&gt;&gt;&amp; pre_calc) &#123;</span><br><span class="line">  int pre_calc_index = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> (int ph = <span class="number">0</span>; ph &lt; pooled_height; ph++) &#123;</span><br><span class="line">    <span class="keyword">for</span> (int pw = <span class="number">0</span>; pw &lt; pooled_width; pw++) &#123;</span><br><span class="line">      <span class="keyword">for</span> (int iy = <span class="number">0</span>; iy &lt; iy_upper; iy++) &#123;</span><br><span class="line">        //计算采样点垂直坐标，按每个小网格大小进行均匀采样roi_bin_grid_h个值</span><br><span class="line">        const T yy = roi_start_h + ph * bin_size_h +</span><br><span class="line">            static_cast&lt;T&gt;(iy + <span class="number">.5</span>f) * bin_size_h /</span><br><span class="line">                static_cast&lt;T&gt;(roi_bin_grid_h); // e.g., <span class="number">0.5</span>, <span class="number">1.5</span></span><br><span class="line">        //计算采样点水平坐标，按每个小网格大小进行均匀采样roi_bin_grid_w个值</span><br><span class="line">        <span class="keyword">for</span> (int ix = <span class="number">0</span>; ix &lt; ix_upper; ix++) &#123;</span><br><span class="line">          const T xx = roi_start_w + pw * bin_size_w +</span><br><span class="line">              static_cast&lt;T&gt;(ix + <span class="number">.5</span>f) * bin_size_w /</span><br><span class="line">                  static_cast&lt;T&gt;(roi_bin_grid_w);</span><br><span class="line"> </span><br><span class="line">          T x = xx;</span><br><span class="line">          T y = yy;</span><br><span class="line">          // deal <span class="keyword">with</span>: inverse elements are out of feature map boundary</span><br><span class="line">          //处理越界</span><br><span class="line">          <span class="keyword">if</span> (y &lt; <span class="number">-1.0</span> || y &gt; height || x &lt; <span class="number">-1.0</span> || x &gt; width) &#123;</span><br><span class="line">            // empty</span><br><span class="line">            PreCalc&lt;T&gt; pc;</span><br><span class="line">            pc.pos1 = <span class="number">0</span>;</span><br><span class="line">            pc.pos2 = <span class="number">0</span>;</span><br><span class="line">            pc.pos3 = <span class="number">0</span>;</span><br><span class="line">            pc.pos4 = <span class="number">0</span>;</span><br><span class="line">            pc.w1 = <span class="number">0</span>;</span><br><span class="line">            pc.w2 = <span class="number">0</span>;</span><br><span class="line">            pc.w3 = <span class="number">0</span>;</span><br><span class="line">            pc.w4 = <span class="number">0</span>;</span><br><span class="line">            pre_calc[pre_calc_index] = pc;</span><br><span class="line">            pre_calc_index += <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">          &#125;</span><br><span class="line"> </span><br><span class="line">          <span class="keyword">if</span> (y &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            y = <span class="number">0</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> (x &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            x = <span class="number">0</span>;</span><br><span class="line">          &#125;</span><br><span class="line"> </span><br><span class="line">          int y_low = (int)y;//采样点y向下取整，找其上方最近的整数坐标</span><br><span class="line">          int x_low = (int)x;//采样点x向下取整，找其左方最近的整数坐标</span><br><span class="line">          int y_high;</span><br><span class="line">          int x_high;</span><br><span class="line"> </span><br><span class="line">          //计算采样点下方最近的整数坐标</span><br><span class="line">          <span class="keyword">if</span> (y_low &gt;= height - <span class="number">1</span>) &#123;</span><br><span class="line">            y_high = y_low = height - <span class="number">1</span>;</span><br><span class="line">            y = (T)y_low;</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            y_high = y_low + <span class="number">1</span>;</span><br><span class="line">          &#125;</span><br><span class="line"> </span><br><span class="line">          //计算采样点右方最近的整数坐标</span><br><span class="line">          <span class="keyword">if</span> (x_low &gt;= width - <span class="number">1</span>) &#123;</span><br><span class="line">            x_high = x_low = width - <span class="number">1</span>;</span><br><span class="line">            x = (T)x_low;</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            x_high = x_low + <span class="number">1</span>;</span><br><span class="line">          &#125;</span><br><span class="line"> </span><br><span class="line">          //根据采样点坐标计算双线性插值对应的四个权重</span><br><span class="line">          T ly = y - y_low;</span><br><span class="line">          T lx = x - x_low;</span><br><span class="line">          T hy = <span class="number">1.</span> - ly, hx = <span class="number">1.</span> - lx;</span><br><span class="line">          T w1 = hy * hx, w2 = hy * lx, w3 = ly * hx, w4 = ly * lx;</span><br><span class="line"> </span><br><span class="line">          // save weights <span class="keyword">and</span> indeces</span><br><span class="line">          PreCalc&lt;T&gt; pc;</span><br><span class="line">          //将坐标换算成在整个输入featuremap中的坐标</span><br><span class="line">          pc.pos1 = y_low * width + x_low;</span><br><span class="line">          pc.pos2 = y_low * width + x_high;</span><br><span class="line">          pc.pos3 = y_high * width + x_low;</span><br><span class="line">          pc.pos4 = y_high * width + x_high;</span><br><span class="line">          pc.w1 = w1;</span><br><span class="line">          pc.w2 = w2;</span><br><span class="line">          pc.w3 = w3;</span><br><span class="line">          pc.w4 = w4;</span><br><span class="line">          pre_calc[pre_calc_index] = pc;</span><br><span class="line"> </span><br><span class="line">          pre_calc_index += <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">/*</span><br><span class="line">nthreads,//输出总长度</span><br><span class="line">bottom_data,//输入数据</span><br><span class="line">spatial_scale,//<span class="number">1</span>/stride(stride可以理解为感受野大小)</span><br><span class="line">channels,//输入数据的第二个维度长度即channel</span><br><span class="line">height,//输入数据的第三个维度长度即h</span><br><span class="line">width,//输入数据的第四个维度长度即w</span><br><span class="line">pooled_height,//pooling后的h</span><br><span class="line">pooled_width,//pooling后的w</span><br><span class="line">sampling_ratio,//pooling中采用的采样点，每个small window采样sampling_ratio_个点然后计算均值作为pooling结果，sampling_ratio_值小于<span class="number">0</span>时采用整个small window所有点求均值</span><br><span class="line">bottom_rois,//roi数据，float类型，<span class="number">5</span>列，分别为roi个数，x1,y1,x2,y2</span><br><span class="line">roi_cols,//roi列数</span><br><span class="line">top_data,//输出数据</span><br><span class="line">*/</span><br><span class="line"> </span><br><span class="line">template &lt;typename T&gt;</span><br><span class="line">void ROIAlignForward(</span><br><span class="line">    const int nthreads,</span><br><span class="line">    const T* bottom_data,</span><br><span class="line">    const T&amp; spatial_scale,</span><br><span class="line">    const int channels,</span><br><span class="line">    const int height,</span><br><span class="line">    const int width,</span><br><span class="line">    const int pooled_height,</span><br><span class="line">    const int pooled_width,</span><br><span class="line">    const int sampling_ratio,</span><br><span class="line">    const T* bottom_rois,</span><br><span class="line">    int roi_cols,</span><br><span class="line">    T* top_data,</span><br><span class="line">    StorageOrder order) &#123;</span><br><span class="line">  DCHECK(roi_cols == <span class="number">4</span> || roi_cols == <span class="number">5</span>);</span><br><span class="line"> </span><br><span class="line">  int n_rois = nthreads / channels / pooled_width / pooled_height;//根据nthreads的计算公式，最终n_rois就是输入到roialign层roi数量</span><br><span class="line">  // (n, c, ph, pw) <span class="keyword">is</span> an element <span class="keyword">in</span> the pooled output</span><br><span class="line">  // can be parallelized using omp</span><br><span class="line">  // <span class="comment">#pragma omp parallel for num_threads(32)</span></span><br><span class="line">  <span class="keyword">for</span> (int n = <span class="number">0</span>; n &lt; n_rois; n++) &#123;</span><br><span class="line">    int index_n = n * channels * pooled_width * pooled_height;//每个roi经过roialign操作输出的索引（网络输出索引）</span><br><span class="line"> </span><br><span class="line">    // roi could have <span class="number">4</span> <span class="keyword">or</span> <span class="number">5</span> columns</span><br><span class="line">    const T* offset_bottom_rois = bottom_rois + n * roi_cols;//每个roi信息的索引</span><br><span class="line">    int roi_batch_ind = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (roi_cols == <span class="number">5</span>) &#123;</span><br><span class="line">      roi_batch_ind = offset_bottom_rois[<span class="number">0</span>];//获取第一个roi的索引</span><br><span class="line">      offset_bottom_rois++;//offset_bottom_rois指向x1</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    // Do <span class="keyword">not</span> using rounding; this implementation detail <span class="keyword">is</span> critical</span><br><span class="line">    T roi_start_w = offset_bottom_rois[<span class="number">0</span>] * spatial_scale;//roi在输入图像中的坐标x1变换到roialign输入featuremap的坐标，float型</span><br><span class="line">    T roi_start_h = offset_bottom_rois[<span class="number">1</span>] * spatial_scale;//roi在输入图像中的坐标y1变换到roialign输入featuremap的坐标，float型</span><br><span class="line">    T roi_end_w = offset_bottom_rois[<span class="number">2</span>] * spatial_scale;//roi在输入图像中的坐标x2变换到roialign输入featuremap的坐标，float型</span><br><span class="line">    T roi_end_h = offset_bottom_rois[<span class="number">3</span>] * spatial_scale;//roi在输入图像中的坐标y2变换到roialign输入featuremap的坐标，float型</span><br><span class="line">    //以下操作则为roipooling的做法，取整丢失了精度</span><br><span class="line">    // T roi_start_w = round(offset_bottom_rois[<span class="number">0</span>] * spatial_scale);</span><br><span class="line">    // T roi_start_h = round(offset_bottom_rois[<span class="number">1</span>] * spatial_scale);</span><br><span class="line">    // T roi_end_w = round(offset_bottom_rois[<span class="number">2</span>] * spatial_scale);</span><br><span class="line">    // T roi_end_h = round(offset_bottom_rois[<span class="number">3</span>] * spatial_scale);</span><br><span class="line"> </span><br><span class="line">    // Force malformed ROIs to be <span class="number">1</span>x1</span><br><span class="line">    T roi_width = std::max(roi_end_w - roi_start_w, (T)<span class="number">1.</span>);//当roi在roialign输入的featuremap中宽度小于<span class="number">1</span>时强制设置为<span class="number">1</span></span><br><span class="line">    T roi_height = std::max(roi_end_h - roi_start_h, (T)<span class="number">1.</span>);//当roi在roialign输入的featuremap中高度小于<span class="number">1</span>时强制设置为<span class="number">1</span></span><br><span class="line">    T bin_size_h = static_cast&lt;T&gt;(roi_height) / static_cast&lt;T&gt;(pooled_height);//计算每个roi分块后每个小块垂直方向包含的bin数量（即尺寸）</span><br><span class="line">    T bin_size_w = static_cast&lt;T&gt;(roi_width) / static_cast&lt;T&gt;(pooled_width);//计算每个roi分块后每个小块水平方向包含的bin数量（即尺寸）</span><br><span class="line"> </span><br><span class="line">    // We use roi_bin_grid to sample the grid <span class="keyword">and</span> mimic integral</span><br><span class="line">    //根据sampling_ratio设置用于pooling的采样点数</span><br><span class="line">    int roi_bin_grid_h = (sampling_ratio &gt; <span class="number">0</span>)</span><br><span class="line">        ? sampling_ratio</span><br><span class="line">        : ceil(roi_height / pooled_height); // e.g., = <span class="number">2</span></span><br><span class="line">    int roi_bin_grid_w =</span><br><span class="line">        (sampling_ratio &gt; 0) ? sampling_ratio : ceil(roi_width / pooled_width);</span><br><span class="line"> </span><br><span class="line">    // We do average (integral) pooling inside a bin</span><br><span class="line">    const T count = roi_bin_grid_h * roi_bin_grid_w; // e.g. = <span class="number">4</span>//采样点总数</span><br><span class="line"> </span><br><span class="line">    // we want to precalculate indeces <span class="keyword">and</span> weights shared by all chanels,</span><br><span class="line">    // this <span class="keyword">is</span> the key point of optimiation</span><br><span class="line">    std::vector&lt;PreCalc&lt;T&gt;&gt; pre_calc(</span><br><span class="line">        roi_bin_grid_h * roi_bin_grid_w * pooled_width * pooled_height);//size为所有分块采样点总数</span><br><span class="line">    //获得双线性插值采样点周围四个坐标的索引以及对应的权重</span><br><span class="line">    pre_calc_for_bilinear_interpolate(</span><br><span class="line">        height,//输入数据的第三个维度长度即h</span><br><span class="line">        width,//输入数据的第四个维度长度即w</span><br><span class="line">        pooled_height,//pooling后的h</span><br><span class="line">        pooled_width,//pooling后的w</span><br><span class="line">        roi_bin_grid_h,//每个小网格内用于pooling的垂直方向采样点数</span><br><span class="line">        roi_bin_grid_w,//每个小网格内用于pooling的水平方向采样点数</span><br><span class="line">        roi_start_h,//roi在输入图像中的坐标y1变换到roialign输入featuremap的坐标，float型</span><br><span class="line">        roi_start_w,//roi在输入图像中的坐标x1变换到roialign输入featuremap的坐标，float型</span><br><span class="line">        bin_size_h,//每个roi分块后每个小块垂直方向包含的bin数量（即尺寸）</span><br><span class="line">        bin_size_w,//每个roi分块后每个小块水平方向包含的bin数量（即尺寸）</span><br><span class="line">        roi_bin_grid_h,//每个小网格内用于pooling的垂直方向采样点数</span><br><span class="line">        roi_bin_grid_w,//每个小网格内用于pooling的水平方向采样点数</span><br><span class="line">        pre_calc);</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> (order == StorageOrder::NCHW) &#123;</span><br><span class="line">      <span class="keyword">for</span> (int c = <span class="number">0</span>; c &lt; channels; c++) &#123;</span><br><span class="line">        int index_n_c = index_n + c * pooled_width * pooled_height;//每个输出对应channel的索引</span><br><span class="line">        const T* offset_bottom_data =</span><br><span class="line">            bottom_data + (roi_batch_ind * channels + c) * height * width;//每个输入featuremap对应channel的索引</span><br><span class="line">        int pre_calc_index = <span class="number">0</span>;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">for</span> (int ph = <span class="number">0</span>; ph &lt; pooled_height; ph++) &#123;</span><br><span class="line">          <span class="keyword">for</span> (int pw = <span class="number">0</span>; pw &lt; pooled_width; pw++) &#123;</span><br><span class="line">            int index = index_n_c + ph * pooled_width + pw;//每个输出坐标的索引</span><br><span class="line"> </span><br><span class="line">            T output_val = <span class="number">0.</span>;//用于统计每个小网格内采样点总数</span><br><span class="line">            //遍历每个小网格内的采样点，根据双线性插值方法计算采样坐标处的值，用于averpooling</span><br><span class="line">            <span class="keyword">for</span> (int iy = <span class="number">0</span>; iy &lt; roi_bin_grid_h; iy++) &#123;</span><br><span class="line">              <span class="keyword">for</span> (int ix = <span class="number">0</span>; ix &lt; roi_bin_grid_w; ix++) &#123;</span><br><span class="line">                PreCalc&lt;T&gt; pc = pre_calc[pre_calc_index];</span><br><span class="line">                output_val += pc.w1 * offset_bottom_data[pc.pos1] +</span><br><span class="line">                    pc.w2 * offset_bottom_data[pc.pos2] +</span><br><span class="line">                    pc.w3 * offset_bottom_data[pc.pos3] +</span><br><span class="line">                    pc.w4 * offset_bottom_data[pc.pos4];</span><br><span class="line"> </span><br><span class="line">                pre_calc_index += <span class="number">1</span>;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            output_val /= count;</span><br><span class="line"> </span><br><span class="line">            top_data[index] = output_val;</span><br><span class="line">          &#125; // <span class="keyword">for</span> pw</span><br><span class="line">        &#125; // <span class="keyword">for</span> ph</span><br><span class="line">      &#125; // <span class="keyword">for</span> c</span><br><span class="line">    &#125; // <span class="keyword">if</span> nchw</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> (order == StorageOrder::NHWC) &#123;</span><br><span class="line">      const T* offset_bottom_data =</span><br><span class="line">          bottom_data + roi_batch_ind * channels * height * width;</span><br><span class="line">      int pre_calc_index = <span class="number">0</span>;</span><br><span class="line"> </span><br><span class="line">      <span class="keyword">for</span> (int ph = <span class="number">0</span>; ph &lt; pooled_height; ph++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (int pw = <span class="number">0</span>; pw &lt; pooled_width; pw++) &#123;</span><br><span class="line">          EVecXf output_vals = EVecXf::Zero(channels);</span><br><span class="line"> </span><br><span class="line">          <span class="keyword">for</span> (int iy = <span class="number">0</span>; iy &lt; roi_bin_grid_h; iy++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (int ix = <span class="number">0</span>; ix &lt; roi_bin_grid_w; ix++) &#123;</span><br><span class="line">              PreCalc&lt;T&gt; pc = pre_calc[pre_calc_index];</span><br><span class="line"> </span><br><span class="line">              ConstEigenVectorMap&lt;T&gt; data_1(</span><br><span class="line">                  offset_bottom_data + channels * pc.pos1, channels);</span><br><span class="line">              ConstEigenVectorMap&lt;T&gt; data_2(</span><br><span class="line">                  offset_bottom_data + channels * pc.pos2, channels);</span><br><span class="line">              ConstEigenVectorMap&lt;T&gt; data_3(</span><br><span class="line">                  offset_bottom_data + channels * pc.pos3, channels);</span><br><span class="line">              ConstEigenVectorMap&lt;T&gt; data_4(</span><br><span class="line">                  offset_bottom_data + channels * pc.pos4, channels);</span><br><span class="line"> </span><br><span class="line">              output_vals += pc.w1 * data_1 + pc.w2 * data_2 + pc.w3 * data_3 +</span><br><span class="line">                  pc.w4 * data_4;</span><br><span class="line"> </span><br><span class="line">              pre_calc_index += <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          output_vals /= count;</span><br><span class="line"> </span><br><span class="line">          int index_nhw = index_n + (ph * pooled_width + pw) * channels;</span><br><span class="line">          std::memcpy(</span><br><span class="line">              top_data + index_nhw, output_vals.data(), channels * sizeof(T));</span><br><span class="line">        &#125; // <span class="keyword">for</span> pw</span><br><span class="line">      &#125; // <span class="keyword">for</span> ph</span><br><span class="line">    &#125; // <span class="keyword">if</span> nhwc</span><br><span class="line"> </span><br><span class="line">  &#125; // <span class="keyword">for</span> n</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">&#125; // namespace</span><br><span class="line"> </span><br><span class="line">template &lt;&gt;</span><br><span class="line">bool RoIAlignOp&lt;float, CPUContext&gt;::RunOnDevice() &#123;</span><br><span class="line">  auto&amp; X = Input(<span class="number">0</span>); // Input data to pool, NCHW</span><br><span class="line">  auto&amp; R = Input(<span class="number">1</span>); // RoIs</span><br><span class="line">  auto* Y = Output(<span class="number">0</span>); // RoI pooled data</span><br><span class="line"> </span><br><span class="line">  <span class="keyword">if</span> (R.size() == <span class="number">0</span>) &#123;</span><br><span class="line">    // Handle empty rois</span><br><span class="line">    <span class="keyword">if</span> (order_ == StorageOrder::NCHW) &#123;</span><br><span class="line">      Y-&gt;Resize(0, X.dim32(1), pooled_height_, pooled_width_);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (order_ == StorageOrder::NHWC) &#123;</span><br><span class="line">      Y-&gt;Resize(0, pooled_height_, pooled_width_, X.dim32(3));</span><br><span class="line">    &#125;</span><br><span class="line">    // The following mutable_data calls are needed to allocate the tensors</span><br><span class="line">    Y-&gt;mutable_data&lt;float&gt;();</span><br><span class="line">    <span class="keyword">return</span> true;</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">  CAFFE_ENFORCE_EQ(R.ndim(), <span class="number">2</span>);</span><br><span class="line">  // <span class="keyword">if</span> R has <span class="number">5</span> columns, the first column <span class="keyword">is</span> the index, otherwise <span class="number">0</span></span><br><span class="line">  CAFFE_ENFORCE(R.dim32(<span class="number">1</span>) == <span class="number">4</span> || R.dim32(<span class="number">1</span>) == <span class="number">5</span>);</span><br><span class="line"> </span><br><span class="line">  <span class="keyword">assert</span>(sampling_ratio_ &gt;= <span class="number">0</span>);</span><br><span class="line"> </span><br><span class="line">  <span class="keyword">if</span> (order_ == StorageOrder::NCHW) &#123;</span><br><span class="line">    Y-&gt;Resize(R.dim32(0), X.dim32(1), pooled_height_, pooled_width_);//ROI数量，输入通道数，pooling后的高，pooling后的宽</span><br><span class="line">    int output_size = Y-&gt;size();//计算输出总长度</span><br><span class="line">    ROIAlignForward&lt;float&gt;(</span><br><span class="line">        output_size,//输出总长度</span><br><span class="line">        X.data&lt;float&gt;(),//输入数据</span><br><span class="line">        spatial_scale_,//<span class="number">1</span>/stride(stride可以理解为感受野大小)</span><br><span class="line">        X.dim32(<span class="number">1</span>),//输入数据的第二个维度长度即channel</span><br><span class="line">        X.dim32(<span class="number">2</span>),//输入数据的第三个维度长度即h</span><br><span class="line">        X.dim32(<span class="number">3</span>),//输入数据的第四个维度长度即w</span><br><span class="line">        pooled_height_,//pooling后的h</span><br><span class="line">        pooled_width_,//pooling后的w</span><br><span class="line">        sampling_ratio_,//pooling中采用的采样点，每个small window采样sampling_ratio_个点然后计算均值作为pooling结果，sampling_ratio_值小于<span class="number">0</span>时采用整个small window所有点求均值</span><br><span class="line">        R.data&lt;float&gt;(),//roi数据，<span class="number">5</span>列，分别为roi个数，x1,y1,x2,y2</span><br><span class="line">        R.dim32(<span class="number">1</span>),//roi列数</span><br><span class="line">        Y-&gt;mutable_data&lt;float&gt;(),//输出数据</span><br><span class="line">        order_);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (order_ == StorageOrder::NHWC) &#123;</span><br><span class="line">    Y-&gt;Resize(R.dim32(0), pooled_height_, pooled_width_, X.dim32(3));</span><br><span class="line">    int output_size = Y-&gt;size();</span><br><span class="line">    ROIAlignForward&lt;float&gt;(</span><br><span class="line">        output_size,</span><br><span class="line">        X.data&lt;float&gt;(),</span><br><span class="line">        spatial_scale_,</span><br><span class="line">        X.dim32(<span class="number">3</span>),</span><br><span class="line">        X.dim32(<span class="number">1</span>),</span><br><span class="line">        X.dim32(<span class="number">2</span>),</span><br><span class="line">        pooled_height_,</span><br><span class="line">        pooled_width_,</span><br><span class="line">        sampling_ratio_,</span><br><span class="line">        R.data&lt;float&gt;(),</span><br><span class="line">        R.dim32(<span class="number">1</span>),</span><br><span class="line">        Y-&gt;mutable_data&lt;float&gt;(),</span><br><span class="line">        order_);</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">  <span class="keyword">return</span> true;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">REGISTER_CPU_OPERATOR(RoIAlign, RoIAlignOp&lt;float, CPUContext&gt;);</span><br><span class="line"> </span><br><span class="line"><span class="comment">#ifdef CAFFE2_HAS_MKL_DNN</span></span><br><span class="line">REGISTER_MKL_OPERATOR(</span><br><span class="line">    RoIAlign,</span><br><span class="line">    mkl::MKLFallbackOp&lt;RoIAlignOp&lt;float, CPUContext&gt;&gt;);</span><br><span class="line"><span class="comment">#endif // CAFFE2_HAS_MKL_DNN</span></span><br><span class="line"> </span><br><span class="line">// Input: X, rois; Output: Y</span><br><span class="line">OPERATOR_SCHEMA(RoIAlign)</span><br><span class="line">    .NumInputs(<span class="number">2</span>)</span><br><span class="line">    .NumOutputs(<span class="number">1</span>)</span><br><span class="line">    .SetDoc(R<span class="string">"DOC(</span></span><br><span class="line"><span class="string">Region of Interest (RoI) align operation as used in Mask R-CNN.</span></span><br><span class="line"><span class="string">)DOC"</span>)</span><br><span class="line">    .Arg(</span><br><span class="line">        <span class="string">"spatial_scale"</span>,</span><br><span class="line">        <span class="string">"(float) default 1.0; Spatial scale of the input feature map X "</span></span><br><span class="line">        <span class="string">"relative to the input image. E.g., 0.0625 if X has a stride of 16 "</span></span><br><span class="line">        <span class="string">"w.r.t. the input image."</span>)</span><br><span class="line">    .Arg(<span class="string">"pooled_h"</span>, <span class="string">"(int) default 1; Pooled output Y's height."</span>)</span><br><span class="line">    .Arg(<span class="string">"pooled_w"</span>, <span class="string">"(int) default 1; Pooled output Y's width."</span>)</span><br><span class="line">    .Arg(</span><br><span class="line">        <span class="string">"sampling_ratio"</span>,</span><br><span class="line">        <span class="string">"(int) default -1; number of sampling points in the interpolation grid "</span></span><br><span class="line">        <span class="string">"used to compute the output value of each pooled output bin. If &gt; 0, "</span></span><br><span class="line">        <span class="string">"then exactly sampling_ratio x sampling_ratio grid points are used. If "</span></span><br><span class="line">        <span class="string">"&lt;= 0, then an adaptive number of grid points are used (computed as "</span></span><br><span class="line">        <span class="string">"ceil(roi_width / pooled_w), and likewise for height)."</span>)</span><br><span class="line">    .Input(<span class="number">0</span>, <span class="string">"X"</span>, <span class="string">"4D feature map input of shape (N, C, H, W)."</span>)</span><br><span class="line">    .Input(</span><br><span class="line">        <span class="number">1</span>,</span><br><span class="line">        <span class="string">"RoIs"</span>,</span><br><span class="line">        <span class="string">"2D input of shape (R, 5) specifying R RoIs with five columns "</span></span><br><span class="line">        <span class="string">"representing: batch index in [0, N - 1], x1, y1, x2, y2. The RoI "</span></span><br><span class="line">        <span class="string">"coordinates are in the coordinate system of the input image."</span>)</span><br><span class="line">    .Output(</span><br><span class="line">        <span class="number">0</span>,</span><br><span class="line">        <span class="string">"Y"</span>,</span><br><span class="line">        <span class="string">"4D output of shape (R, C, pooled_h, pooled_w). The r-th batch element "</span></span><br><span class="line">        <span class="string">"is a pooled feature map cooresponding to the r-th RoI."</span>);</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://xytian.me/2018/05/01/Research-Notes/Object Detection and Segmentation/3. Object Detection/3. No Region Proposal/Focal-Loss-RetinaNet/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Xingye Tian">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://p3rz3gu1u.bkt.clouddn.com/2018-07-26-ME.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Xingye Tian">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/05/01/Research-Notes/Object Detection and Segmentation/3. Object Detection/3. No Region Proposal/Focal-Loss-RetinaNet/" itemprop="url">Untitled</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-05-01T06:43:30+08:00">
                2018-05-01
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">Post modified&#58;</span>
              
              <time title="Post modified" itemprop="dateModified" datetime="2018-07-03T10:29:56+08:00">
                2018-07-03
              </time>
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a href="https://arxiv.org/abs/1708.02002" target="_blank" rel="noopener">[1708.02002] Focal Loss for Dense Object Detection</a></p>
<h2 id="Key-Ideas-of-this-paper"><a href="#Key-Ideas-of-this-paper" class="headerlink" title="Key Ideas of this paper"></a>Key Ideas of this paper</h2><ul>
<li>The author think that one-stage object detection methods are less accurate than two-stage methods because of extrame foreground-background class imblance.</li>
<li>They propose to address this class imbalance by reshaping the standard cross entropy loss such that it down-weights the loss assigned to well-classified examples and focus more on hard examples. </li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:center">Focal-Loss</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><p float="left"> <img src="http://p3rz3gu1u.bkt.clouddn.com/2018-06-30-Focal-Loss.png" width="400">  </p></td>
</tr>
</tbody>
</table>
<ul>
<li>A one-stage object detection method called RetinaNet is proposed based on the idea of Focal Loss. Feature Pyramid Network(FPN) is used as the backbone net and two seperate Fully Conventional Networks(FCN) are used  as subnets to predict the class and localization of objects. Focal Loss is applied to the class prediction subnet and smooth L1 loss to the localization subnet.</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:center">RetinaNet</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><p float="left"> <img src="http://p3rz3gu1u.bkt.clouddn.com/2018-06-30-RetinaNet.png" width="800">  </p></td>
</tr>
</tbody>
</table>
<ul>
<li>Results show that when trained with the Focal Loss, RetinaNet is able to match the speed of previous one-stage detectors while surpassing the accuracy of all existing state-of-the-art two-stage detectors. </li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:center">Performance of RetinaNet</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><p float="left"> <img src="http://p3rz3gu1u.bkt.clouddn.com/2018-06-30-RetinaNet-Performance.png" width="400">  </p></td>
</tr>
</tbody>
</table>
<h2 id="Implementation-in-Pytorch"><a href="#Implementation-in-Pytorch" class="headerlink" title="Implementation in Pytorch"></a>Implementation in Pytorch</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">import</span> torch.nn.functional <span class="keyword">as</span> F</span><br><span class="line"><span class="keyword">from</span> torch.autograd <span class="keyword">import</span> Variable</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">one_hot</span><span class="params">(index, classes)</span>:</span></span><br><span class="line">    size = index.size() + (classes,)</span><br><span class="line">    view = index.size() + (<span class="number">1</span>,)</span><br><span class="line">    mask = torch.Tensor(*size).fill_(<span class="number">0</span>)</span><br><span class="line">    index = index.view(*view)</span><br><span class="line">    ones = <span class="number">1.</span></span><br><span class="line">    <span class="keyword">if</span> isinstance(index, Variable):</span><br><span class="line">        ones = Variable(torch.Tensor(index.size()).fill_(<span class="number">1</span>))</span><br><span class="line">        mask = Variable(mask, volatile=index.volatile)</span><br><span class="line">    <span class="keyword">return</span> mask.scatter_(<span class="number">1</span>, index, ones)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FocalLoss</span><span class="params">(nn.Module)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, gamma=<span class="number">0</span>, eps=<span class="number">1e-7</span>)</span>:</span></span><br><span class="line">        super(FocalLoss, self).__init__()</span><br><span class="line">        self.gamma = gamma</span><br><span class="line">        self.eps = eps</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span><span class="params">(self, input, target)</span>:</span></span><br><span class="line">        y = one_hot(target, input.size(<span class="number">-1</span>))</span><br><span class="line">        logit = F.softmax(input)</span><br><span class="line">        logit = logit.clamp(self.eps, <span class="number">1.</span> - self.eps)</span><br><span class="line">        loss = <span class="number">-1</span> * y * torch.log(logit) <span class="comment"># cross entropy</span></span><br><span class="line">        loss = loss * (<span class="number">1</span> - logit) ** self.gamma <span class="comment"># focal loss</span></span><br><span class="line">        <span class="keyword">return</span> loss.sum()</span><br></pre></td></tr></table></figure>
<h2 id="Solutions-to-Class-Imbalance-tasks-Comments"><a href="#Solutions-to-Class-Imbalance-tasks-Comments" class="headerlink" title="Solutions to Class-Imbalance tasks (Comments)"></a>Solutions to Class-Imbalance tasks (Comments)</h2><ul>
<li>Resampling and re-design loss function are two common solutions to class-imblance tasks.</li>
<li>Two-stage detection methods like Faster R-CNN applied resampling method. In RPN and Fast R-CNN part of Faster R-CNN, the foreground and background samples are kept 128:128 and 32:96.</li>
<li>One stage methods like RetinaNet use all anchors to train the model, they can not select balanced samples. So try to improve the loss function seems to be the only choice.</li>
</ul>
<p>​    </p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://xytian.me/2018/05/01/Research-Notes/Object Detection and Segmentation/3. Object Detection/1. Backbones/Feature-Pyramid-Networks/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Xingye Tian">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://p3rz3gu1u.bkt.clouddn.com/2018-07-26-ME.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Xingye Tian">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/05/01/Research-Notes/Object Detection and Segmentation/3. Object Detection/1. Backbones/Feature-Pyramid-Networks/" itemprop="url">Feature Pyramid Networks</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-05-01T06:43:30+08:00">
                2018-05-01
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">Post modified&#58;</span>
              
              <time title="Post modified" itemprop="dateModified" datetime="2018-07-26T18:56:28+08:00">
                2018-07-26
              </time>
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/General-Object-Detection/" itemprop="url" rel="index">
                    <span itemprop="name">General-Object-Detection</span>
                  </a>
                </span>

                
                
                  >
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/General-Object-Detection/No-Region-Proposal/" itemprop="url" rel="index">
                    <span itemprop="name">No-Region-Proposal</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Meta-Information"><a href="#Meta-Information" class="headerlink" title="Meta Information"></a>Meta Information</h2><ul>
<li>author : FAIR</li>
<li>year : 2017</li>
</ul>
<h2 id="Key-Idea"><a href="#Key-Idea" class="headerlink" title="Key Idea"></a>Key Idea</h2><table>
<thead>
<tr>
<th style="text-align:center">Basic-Structure-FPN</th>
<th style="text-align:center">Lateral-Connection</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><p float="left"> <img src="http://p3rz3gu1u.bkt.clouddn.com/2018-06-29-Basic-Structure-FPN.png" width="300">  </p></td>
<td style="text-align:center"><p float="left"> <img src="http://p3rz3gu1u.bkt.clouddn.com/2018-06-29-Connection.png" width="300">  </p></td>
</tr>
</tbody>
</table>
<ul>
<li>Later feature maps in Convs have more semantic information than earlier feature maps, but part of localization have been lost because of too many down samplings. To achive better performance in CV tasks like object detection, localization informantion is needed.</li>
<li>This paper use information in bottom-up path and top-down path, join them together using lateral connections. So feature maps (called P2, P3, …) can have both semantic information from later feature maps and localization information from ealier feature maps.</li>
<li>The feature maps from FPN (which are P1, P2, …) can be used in tasks like RPN and Fast R-CNN to provide more information to improve task performance. Because there are more than one feature maps in the output of FPN, RPN and Fast R-CNN based one them are slightly different form original ones. Details of how to use FPN in RPN and Fast R-CNN are in the original paper.</li>
</ul>
<h2 id="Implementation-in-Pytorch"><a href="#Implementation-in-Pytorch" class="headerlink" title="Implementation in Pytorch"></a>Implementation in Pytorch</h2><ul>
<li>Source code :<a href="https://github.com/kuangliu/pytorch-fpn/blob/master/fpn.py" target="_blank" rel="noopener">pytorch-fpn</a></li>
<li>Bottom-up and top-down branch are implenmented in the code, as well as lateral connections.</li>
<li>The output of the net are a list of feature maps which can be further used in RPN and Faster R-CNN part.</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'''FPN in PyTorch.</span></span><br><span class="line"><span class="string">See the paper "Feature Pyramid Networks for Object Detection" for more details.</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">import</span> torch.nn.functional <span class="keyword">as</span> F</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> torch.autograd <span class="keyword">import</span> Variable</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Bottleneck</span><span class="params">(nn.Module)</span>:</span></span><br><span class="line">    expansion = <span class="number">4</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, in_planes, planes, stride=<span class="number">1</span>)</span>:</span></span><br><span class="line">        super(Bottleneck, self).__init__()</span><br><span class="line">        self.conv1 = nn.Conv2d(in_planes, planes, kernel_size=<span class="number">1</span>, bias=<span class="keyword">False</span>)</span><br><span class="line">        self.bn1 = nn.BatchNorm2d(planes)</span><br><span class="line">        self.conv2 = nn.Conv2d(planes, planes, kernel_size=<span class="number">3</span>, stride=stride, padding=<span class="number">1</span>, bias=<span class="keyword">False</span>)</span><br><span class="line">        self.bn2 = nn.BatchNorm2d(planes)</span><br><span class="line">        self.conv3 = nn.Conv2d(planes, self.expansion*planes, kernel_size=<span class="number">1</span>, bias=<span class="keyword">False</span>)</span><br><span class="line">        self.bn3 = nn.BatchNorm2d(self.expansion*planes)</span><br><span class="line"></span><br><span class="line">        self.shortcut = nn.Sequential()</span><br><span class="line">        <span class="keyword">if</span> stride != <span class="number">1</span> <span class="keyword">or</span> in_planes != self.expansion*planes:</span><br><span class="line">            self.shortcut = nn.Sequential(</span><br><span class="line">                nn.Conv2d(in_planes, self.expansion*planes, kernel_size=<span class="number">1</span>, stride=stride, bias=<span class="keyword">False</span>),</span><br><span class="line">                nn.BatchNorm2d(self.expansion*planes)</span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span><span class="params">(self, x)</span>:</span></span><br><span class="line">        out = F.relu(self.bn1(self.conv1(x)))</span><br><span class="line">        out = F.relu(self.bn2(self.conv2(out)))</span><br><span class="line">        out = self.bn3(self.conv3(out))</span><br><span class="line">        out += self.shortcut(x)</span><br><span class="line">        out = F.relu(out)</span><br><span class="line">        <span class="keyword">return</span> out</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FPN</span><span class="params">(nn.Module)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, block, num_blocks)</span>:</span></span><br><span class="line">        super(FPN, self).__init__()</span><br><span class="line">        self.in_planes = <span class="number">64</span></span><br><span class="line"></span><br><span class="line">        self.conv1 = nn.Conv2d(<span class="number">3</span>, <span class="number">64</span>, kernel_size=<span class="number">7</span>, stride=<span class="number">2</span>, padding=<span class="number">3</span>, bias=<span class="keyword">False</span>)</span><br><span class="line">        self.bn1 = nn.BatchNorm2d(<span class="number">64</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Bottom-up layers</span></span><br><span class="line">        self.layer1 = self._make_layer(block,  <span class="number">64</span>, num_blocks[<span class="number">0</span>], stride=<span class="number">1</span>)</span><br><span class="line">        self.layer2 = self._make_layer(block, <span class="number">128</span>, num_blocks[<span class="number">1</span>], stride=<span class="number">2</span>)</span><br><span class="line">        self.layer3 = self._make_layer(block, <span class="number">256</span>, num_blocks[<span class="number">2</span>], stride=<span class="number">2</span>)</span><br><span class="line">        self.layer4 = self._make_layer(block, <span class="number">512</span>, num_blocks[<span class="number">3</span>], stride=<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Top layer</span></span><br><span class="line">        self.toplayer = nn.Conv2d(<span class="number">2048</span>, <span class="number">256</span>, kernel_size=<span class="number">1</span>, stride=<span class="number">1</span>, padding=<span class="number">0</span>)  <span class="comment"># Reduce channels</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Smooth layers</span></span><br><span class="line">        self.smooth1 = nn.Conv2d(<span class="number">256</span>, <span class="number">256</span>, kernel_size=<span class="number">3</span>, stride=<span class="number">1</span>, padding=<span class="number">1</span>)</span><br><span class="line">        self.smooth2 = nn.Conv2d(<span class="number">256</span>, <span class="number">256</span>, kernel_size=<span class="number">3</span>, stride=<span class="number">1</span>, padding=<span class="number">1</span>)</span><br><span class="line">        self.smooth3 = nn.Conv2d(<span class="number">256</span>, <span class="number">256</span>, kernel_size=<span class="number">3</span>, stride=<span class="number">1</span>, padding=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Lateral layers</span></span><br><span class="line">        self.latlayer1 = nn.Conv2d(<span class="number">1024</span>, <span class="number">256</span>, kernel_size=<span class="number">1</span>, stride=<span class="number">1</span>, padding=<span class="number">0</span>)</span><br><span class="line">        self.latlayer2 = nn.Conv2d( <span class="number">512</span>, <span class="number">256</span>, kernel_size=<span class="number">1</span>, stride=<span class="number">1</span>, padding=<span class="number">0</span>)</span><br><span class="line">        self.latlayer3 = nn.Conv2d( <span class="number">256</span>, <span class="number">256</span>, kernel_size=<span class="number">1</span>, stride=<span class="number">1</span>, padding=<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_make_layer</span><span class="params">(self, block, planes, num_blocks, stride)</span>:</span></span><br><span class="line">        strides = [stride] + [<span class="number">1</span>]*(num_blocks<span class="number">-1</span>)</span><br><span class="line">        layers = []</span><br><span class="line">        <span class="keyword">for</span> stride <span class="keyword">in</span> strides:</span><br><span class="line">            layers.append(block(self.in_planes, planes, stride))</span><br><span class="line">            self.in_planes = planes * block.expansion</span><br><span class="line">        <span class="keyword">return</span> nn.Sequential(*layers)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_upsample_add</span><span class="params">(self, x, y)</span>:</span></span><br><span class="line">        <span class="string">'''Upsample and add two feature maps.</span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">          x: (Variable) top feature map to be upsampled.</span></span><br><span class="line"><span class="string">          y: (Variable) lateral feature map.</span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">          (Variable) added feature map.</span></span><br><span class="line"><span class="string">        Note in PyTorch, when input size is odd, the upsampled feature map</span></span><br><span class="line"><span class="string">        with `F.upsample(..., scale_factor=2, mode='nearest')`</span></span><br><span class="line"><span class="string">        maybe not equal to the lateral feature map size.</span></span><br><span class="line"><span class="string">        e.g.</span></span><br><span class="line"><span class="string">        original input size: [N,_,15,15] -&gt;</span></span><br><span class="line"><span class="string">        conv2d feature map size: [N,_,8,8] -&gt;</span></span><br><span class="line"><span class="string">        upsampled feature map size: [N,_,16,16]</span></span><br><span class="line"><span class="string">        So we choose bilinear upsample which supports arbitrary output sizes.</span></span><br><span class="line"><span class="string">        '''</span></span><br><span class="line">        _,_,H,W = y.size()</span><br><span class="line">        <span class="keyword">return</span> F.upsample(x, size=(H,W), mode=<span class="string">'bilinear'</span>) + y</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span><span class="params">(self, x)</span>:</span></span><br><span class="line">        <span class="comment"># Bottom-up</span></span><br><span class="line">        c1 = F.relu(self.bn1(self.conv1(x)))</span><br><span class="line">        c1 = F.max_pool2d(c1, kernel_size=<span class="number">3</span>, stride=<span class="number">2</span>, padding=<span class="number">1</span>)</span><br><span class="line">        c2 = self.layer1(c1)</span><br><span class="line">        c3 = self.layer2(c2)</span><br><span class="line">        c4 = self.layer3(c3)</span><br><span class="line">        c5 = self.layer4(c4)</span><br><span class="line">        <span class="comment"># Top-down</span></span><br><span class="line">        p5 = self.toplayer(c5)</span><br><span class="line">        p4 = self._upsample_add(p5, self.latlayer1(c4))</span><br><span class="line">        p3 = self._upsample_add(p4, self.latlayer2(c3))</span><br><span class="line">        p2 = self._upsample_add(p3, self.latlayer3(c2))</span><br><span class="line">        <span class="comment"># Smooth</span></span><br><span class="line">        p4 = self.smooth1(p4)</span><br><span class="line">        p3 = self.smooth2(p3)</span><br><span class="line">        p2 = self.smooth3(p2)</span><br><span class="line">        <span class="keyword">return</span> p2, p3, p4, p5</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">FPN101</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment"># return FPN(Bottleneck, [2,4,23,3])</span></span><br><span class="line">    <span class="keyword">return</span> FPN(Bottleneck, [<span class="number">2</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">2</span>])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test</span><span class="params">()</span>:</span></span><br><span class="line">    net = FPN101()</span><br><span class="line">    fms = net(Variable(torch.randn(<span class="number">1</span>,<span class="number">3</span>,<span class="number">600</span>,<span class="number">900</span>)))</span><br><span class="line">    <span class="keyword">for</span> fm <span class="keyword">in</span> fms:</span><br><span class="line">        print(fm.size())</span><br><span class="line"></span><br><span class="line"><span class="comment"># Output of test()</span></span><br><span class="line"><span class="comment"># torch.Size([1, 256, 150, 225])</span></span><br><span class="line"><span class="comment"># torch.Size([1, 256, 75, 113])</span></span><br><span class="line"><span class="comment"># torch.Size([1, 256, 38, 57])</span></span><br><span class="line"><span class="comment"># torch.Size([1, 256, 19, 29])</span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://xytian.me/2018/05/01/Research-Notes/Object Detection and Segmentation/3. Object Detection/0. Summary/General-Object-Detection-Summary/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Xingye Tian">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://p3rz3gu1u.bkt.clouddn.com/2018-07-26-ME.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Xingye Tian">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/05/01/Research-Notes/Object Detection and Segmentation/3. Object Detection/0. Summary/General-Object-Detection-Summary/" itemprop="url">Feature Pyramid Networks</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-05-01T06:43:30+08:00">
                2018-05-01
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">Post modified&#58;</span>
              
              <time title="Post modified" itemprop="dateModified" datetime="2018-07-26T19:12:32+08:00">
                2018-07-26
              </time>
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/General-Object-Detection/" itemprop="url" rel="index">
                    <span itemprop="name">General-Object-Detection</span>
                  </a>
                </span>

                
                
                  >
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/General-Object-Detection/No-Region-Proposal/" itemprop="url" rel="index">
                    <span itemprop="name">No-Region-Proposal</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><img src="http://p3rz3gu1u.bkt.clouddn.com/2018-06-30-085442.png" alt=""></p>
<table>
<thead>
<tr>
<th></th>
<th>2012</th>
<th>2013</th>
<th>2014</th>
<th>2015</th>
<th>2016</th>
<th>2017</th>
<th>2018</th>
</tr>
</thead>
<tbody>
<tr>
<td>Two-Stage</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>One-Dtage</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Backbone</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>Ref</p>
<ul>
<li><a href="https://zhuanlan.zhihu.com/p/36088972" target="_blank" rel="noopener">【重磅】基于深度学习的目标检测算法综述</a></li>
<li><a href="https://handong1587.github.io/deep_learning/2015/10/09/object-detection.html" target="_blank" rel="noopener">Object Detection - handong1587</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://xytian.me/2018/05/01/Research-Notes/Object Detection and Segmentation/3. Object Detection/5. Others/OverFeat/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Xingye Tian">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://p3rz3gu1u.bkt.clouddn.com/2018-07-26-ME.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Xingye Tian">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/05/01/Research-Notes/Object Detection and Segmentation/3. Object Detection/5. Others/OverFeat/" itemprop="url">Feature Pyramid Networks</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-05-01T06:43:30+08:00">
                2018-05-01
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">Post modified&#58;</span>
              
              <time title="Post modified" itemprop="dateModified" datetime="2018-07-26T19:12:51+08:00">
                2018-07-26
              </time>
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/General-Object-Detection/" itemprop="url" rel="index">
                    <span itemprop="name">General-Object-Detection</span>
                  </a>
                </span>

                
                
                  >
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/General-Object-Detection/No-Region-Proposal/" itemprop="url" rel="index">
                    <span itemprop="name">No-Region-Proposal</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Meta-Information"><a href="#Meta-Information" class="headerlink" title="Meta Information"></a>Meta Information</h2><ul>
<li>author : LeCun group</li>
<li>Year : 2013</li>
</ul>
<h2 id="Key-Ideas"><a href="#Key-Ideas" class="headerlink" title="Key Ideas"></a>Key Ideas</h2><ol>
<li><p>Shared features for multi-task learning. AlexNet was improved by this paper for multi-task learning. Features learned with classification task can be easilly applied to localization and detection tasks by justing changing the last few layers of the network.</p>
</li>
<li><p>Idea of fully convolutional network.</p>
<p><img src="http://p3rz3gu1u.bkt.clouddn.com/2018-07-02-025309.png" alt=""></p>
</li>
<li><p>Sliding window on feature map rather than raw image, which saved a lot of computation compared with raw-image-sliding-window methods. The idea of using feature map information are used a lot in latter methods like Fast R-CNN.</p>
</li>
</ol>
<h2 id="Shortcomings"><a href="#Shortcomings" class="headerlink" title="Shortcomings"></a>Shortcomings</h2><ol>
<li>Multi-scale sliding window method was applied, which led to too much computation.</li>
<li>The backbone network (OverFeat) was sitll too weak with not enough ability for feature representation.</li>
</ol>
<h2 id="Historical-position"><a href="#Historical-position" class="headerlink" title="Historical position"></a>Historical position</h2><ul>
<li>This is an old paper (2014) and has been replaced by SSD and YOLO for more realtime detections. </li>
<li>However the paper does provide interesting perspective. </li>
<li>On the ILSVRC 2013 dataset OverFeat ranked 4th in classification, 1st in localization, and 1st in detection.</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://xytian.me/2018/01/19/Research-Notes/Neural-Networks/README/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Xingye Tian">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://p3rz3gu1u.bkt.clouddn.com/2018-07-26-ME.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Xingye Tian">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/19/Research-Notes/Neural-Networks/README/" itemprop="url">Untitled</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-01-19T09:27:27+08:00">
                2018-01-19
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">Post modified&#58;</span>
              
              <time title="Post modified" itemprop="dateModified" datetime="2018-01-19T09:27:27+08:00">
                2018-01-19
              </time>
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Topics-About-Neural-Network"><a href="#Topics-About-Neural-Network" class="headerlink" title="Topics About Neural Network"></a>Topics About Neural Network</h1><p>Covers some topics about neural network. Including weights initialization and regularzation and so on.</p>
<h2 id="WeightInitialization"><a href="#WeightInitialization" class="headerlink" title="WeightInitialization"></a><a href="https://github.com/txytju/TopicsInNeuralNetwork/tree/master/WeightInitialization" target="_blank" rel="noopener">WeightInitialization</a></h2>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="http://p3rz3gu1u.bkt.clouddn.com/2018-07-26-ME.jpeg"
                alt="Xingye Tian" />
            
              <p class="site-author-name" itemprop="name">Xingye Tian</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">23</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">13</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">1</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/txytju" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-globe"></i>GitHub</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Xingye Tian</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
